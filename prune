#!/usr/bin/env bash

function update_repo() {
    local dir="$1"
    local remote_url="$2"
    
    echo "Checking updates for $(basename "$dir")..."
    cd "$dir" || return
    [ -n "$remote_url" ] && git config remote.origin.url "$remote_url"
    
    local current_hash
    current_hash=$(git rev-parse HEAD)
    
    git pull
    
    if [ "$(git rev-parse HEAD)" != "$current_hash" ]; then
        echo "Updates detected in $(basename "$dir"). Restarting script..."
        exec "$0" "$@"
    fi
}

update_repo ~/.confbook "https://github.com/crzidea/confbook.git"
update_repo "$(dirname "$0")" "https://github.com/crzidea/local-bin.git"

df -h

# Check total physical memory in MB
total_mem=$(free -m | awk '/^Mem:/{print $2}')

if [ "$total_mem" -lt 512 ]; then
    echo "Memory is less than 512MB ($total_mem MB). Ensuring swap is on."
    if [ ! -f /swapfile ]; then
        echo "Creating /swapfile..."
        sudo fallocate -l 512M /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=512
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
    fi
    if ! sudo swapon --show | grep -q "/swapfile"; then
        sudo swapon /swapfile
    else
        echo "Swap is already active."
    fi
else
    echo "Memory is sufficient ($total_mem MB). Turning off swap."
    sudo swapoff -a
    if [ -f /swapfile ]; then
        sudo rm /swapfile
    fi
fi
ulimit -n 65535

echo "Pruning docker system..."
docker system prune --volumes -f

echo "Truncating docker logs..."
docker ps -aq | xargs docker inspect --format='{{.LogPath}}' | xargs sudo truncate -s 0

echo "Stopping services..."
sudo systemctl stop docker
sudo systemctl stop warp-svc

echo "Updating Cloudflare Warp key..."
curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg

echo "Running apt autoremove..."
sudo apt autoremove -y

echo "Updating apt packages..."
sudo apt update
sudo apt upgrade -y

echo "Starting services..."
sudo systemctl start docker
sudo systemctl start warp-svc

echo "Vacuuming journalctl..."
#journalctl --vacuum-size=100m
journalctl --vacuum-size=100000000
#sudo journalctl --vacuum-size=100m
sudo journalctl --vacuum-size=100000000

echo "Removing old logs and crash reports..."
sudo rm /var/log/*.log.*.gz
sudo rm /var/lib/cloudflare-warp/crash_reports/*

echo "Cleaning npm cache..."
npm cache clean --force

df -h

# Reconnect warp
# echo "Reconnect warp..."
# warp-cli disconnect
# warp-cli connect
