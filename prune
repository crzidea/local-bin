#!/usr/bin/env bash
cd ~/.confbook
git config remote.origin.url https://github.com/crzidea/confbook.git
git pull
cd "$(dirname "$0")"
git config remote.origin.url https://github.com/crzidea/local-bin.git
git pull
df -h

# Check total physical memory in MB
total_mem=$(free -m | awk '/^Mem:/{print $2}')

if [ "$total_mem" -lt 512 ]; then
    echo "Memory is less than 512MB ($total_mem MB). Ensuring swap is on."
    if [ ! -f /swapfile ]; then
        echo "Creating /swapfile..."
        sudo fallocate -l 512M /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=512
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
    fi
    if ! sudo swapon --show | grep -q "/swapfile"; then
        sudo swapon /swapfile
    else
        echo "Swap is already active."
    fi
else
    echo "Memory is sufficient ($total_mem MB). Turning off swap."
    sudo swapoff -a
    if [ -f /swapfile ]; then
        sudo rm /swapfile
    fi
fi
ulimit -n 65535
docker system prune -f
docker container prune -f
docker image prune -f
docker volume prune -f
docker network prune -f
docker ps -aq | xargs docker inspect --format='{{.LogPath}}' | xargs sudo truncate -s 0
sudo systemctl stop docker
sudo systemctl stop warp-svc
curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
sudo apt autoremove -y
sudo apt update
sudo apt upgrade -y
sudo systemctl start docker
sudo systemctl start warp-svc
#journalctl --vacuum-size=100m
journalctl --vacuum-size=100000000
#sudo journalctl --vacuum-size=100m
sudo journalctl --vacuum-size=100000000
sudo rm /var/log/*.log.*.gz
sudo rm /var/lib/cloudflare-warp/crash_reports/*
npm cache clean --force

df -h

# Reconnect warp
warp-cli disconnect
warp-cli connect
